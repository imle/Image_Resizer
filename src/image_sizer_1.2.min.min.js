$.widget("custom.cropper",{version:"1.2",widget_event_prefix:"cropping",options:{height:400,width:400,zoom:2,contain:false,image_url:"http://placehold.it/1280x720",button:null,submit:function(){},slide:function(){},drag:function(){},ready:function(){}},limits:{min:{height:100,width:100,zoom:2},max:{height:500,width:700,zoom:4}},_create:function(){this.element.hide();this._createElements();this._setValueLimits();this._getElements();this._setImage()},_setup:function(c){c.$outer_container.height(c.options.height);c.$outer_container.width(c.options.width);c.original_height=parseInt(c.$foreground_image.height());c.original_width=parseInt(c.$foreground_image.width());var d={height:c.$main_container.outerHeight(),width:c.original_width*(c.$main_container.outerHeight()/c.original_height)};if(c.options.width>c.original_width){d.height=d.height*(c.options.width/d.width);d.top=-(parseInt(c.$main_container.css("padding-top")))*(c.options.width/d.width);d.width=c.options.width}c.$foreground_image.css(d);c.$background_image.css(d);c.initial_height=parseInt(c.$foreground_image.height());c.initial_width=parseInt(c.$foreground_image.width());d={left:-(c.initial_width/2-c.options.width/2),top:d.top||-(parseInt(c.$main_container.css("padding-top")))};c.$foreground_image.css(d);c.$drag_helper.css(d);c.$resize_container.css({height:c.initial_height*2-c.options.height,width:c.initial_width*2-c.options.width,left:c.options.width-c.initial_width,top:c.options.height-c.initial_height});c.resize_center={x:(c.options.width/2-parseInt(c.$foreground_image.css("left")))/c.initial_width,y:(c.options.height/2-parseInt(c.$foreground_image.css("top")))/c.initial_height};c.minimum=c.options.contain?Math.min(c.options.height/c.initial_height,c.options.width/c.initial_width):Math.max(c.options.height/c.initial_height,c.options.width/c.initial_width);c._createEventListeners(c)},_setImage:function(){var b=this;this.$foreground_image.attr("src",this.options.image_url);this.$background_image.attr("src",this.options.image_url).load(function(){b.element.show();b.options.ready();b._setup(b)})},_getElements:function(){this.$foreground_image=this.element.find("#foreground_crop_image");this.$background_image=this.element.find("#background_crop_image");this.$outer_container=this.element.find("#cropping_gredyed_container");this.$main_container=this.element.find("#cropping_main_container");this.$drag_helper=this.element.find("#cropping_drag_helper");this.$resize_container=this.element.find("#cropping_sizing_container");this.$resize_warning=this.element.find("#cropping_resize_warning")},_setValueLimits:function(){this.options.height=this.options.height<this.limits.min.height?this.limits.min.height:this.options.height>this.limits.max.height?this.limits.max.height:this.options.height;this.options.width=this.options.width<this.limits.min.width?this.limits.min.width:this.options.width>this.limits.max.width?this.limits.max.width:this.options.width;this.options.zoom=this.options.zoom<this.limits.min.zoom?this.limits.min.zoom:this.options.zoom>this.limits.max.zoom?this.limits.max.zoom:this.options.zoom},_createElements:function(){this.element.html('<div id="cropping_main_container"><div id="cropping_gredyed_container"><div id="cropping_sizing_container"></div><div id="cropping_inner_container"><img id="foreground_crop_image" src=""/></div><div id="cropping_drag_helper"><img id="background_crop_image" src=""/><div id="cropping_pointer"></div></div><div id="cropping_dtr"><span>Drag to Reposition</span></div></div><div id="cropping_slider_outer_container"><div id="cropping_slider_container"><div class="cropping_slider_indicator" id="csi_minus"></div><div id="cropping_slider"></div><div class="cropping_slider_indicator" id="csi_plus"></div></div></div><div id="cropping_resize_warning"><span>Zooming in this close will make your photo less clear.</span></div></div><div id="cropping_footer"><div id="save_button"><span>Save</span></div></div>')},_createEventListeners:function(b){if(!this.options.button){this.options.button=this.element.find("#save_button");this.element.find("#cropping_footer").show()}this.options.button.unbind("click").click(function(){var a={left:Math.abs(parseInt(b.$foreground_image.css("left"))),top:Math.abs(parseInt(b.$foreground_image.css("top")))};b.options.submit({height:b.options.height,width:b.options.width,ratio:b.$foreground_image.height()/b.original_height,top_x:a.left/b.$foreground_image.width(),top_y:a.top/b.$foreground_image.height(),bot_x:(a.left+b.options.width)/b.$foreground_image.width(),bot_y:(a.top+b.options.height)/b.$foreground_image.height()});b.element.empty();b.destroy()});this.$drag_helper.draggable({drag:function(a,d){b.resize_center={x:(b.options.width/2-d.position.left)/b.$foreground_image.width(),y:(b.options.height/2-d.position.top)/b.$foreground_image.height()};b.$foreground_image.css({left:d.position.left,top:d.position.top});b.options.drag(a,d)},containment:b.$resize_container});this.element.find("#cropping_slider").slider({max:b.options.zoom*1000,value:1000,min:b.minimum*1000,slide:function(h,g){if(g.value>1000&&b.initial_height*(g.value/1000)>=b.original_height){b.$resize_warning.show()}else{b.$resize_warning.hide()}var i={height:b.initial_height*(g.value/1000),width:b.initial_width*(g.value/1000)};b.$foreground_image.css(i);b.$background_image.css(i);var j={left:-(b.resize_center.x*i.width-b.options.width/2),top:-(b.resize_center.y*i.height-b.options.height/2)};if(!b.options.contain||i.width>=b.options.width||b.minimum==b.options.width/b.initial_width){j.left=j.left>0?0:j.left;j.left=-j.left+b.options.width>i.width?-(i.width-b.options.width)/b.options.width*100+"%":j.left/b.options.width*100+"%"}else{if(i.width<b.options.width){j.left=j.left+i.width>b.options.width?b.options.width-i.width:j.left<0?0:j.left}}if(!b.options.contain||i.height>=b.options.height||b.minimum==b.options.height/b.initial_height){j.top=j.top>0?0:j.top;j.top=-j.top+b.options.height>i.height?-(i.height-b.options.height)/b.options.height*100+"%":j.top/b.options.height*100+"%"}else{if(i.height<b.options.height){j.top=j.top+i.height>b.options.height?b.options.height-i.height:j.top<0?0:j.top}}b.$foreground_image.css(j);b.$drag_helper.css(j);var a={height:i.height*2-b.options.height,width:i.width*2-b.options.width,left:b.options.width-i.width,top:b.options.height-i.height};a.height=b.options.contain&&a.height<b.options.height?b.options.height:a.height;a.width=b.options.contain&&a.width<b.options.width?b.options.width:a.width;a.left=b.options.contain&&a.left>0?0:a.left;a.top=b.options.contain&&a.top>0?0:a.top;b.$resize_container.css(a);b.options.slide(h,g)}})},ratio:function(){return this.$foreground_image.height()/this.original_height},start:function(){return{x:Math.abs(parseInt(this.$foreground_image.css("left")))/this.$foreground_image.width(),y:Math.abs(parseInt(this.$foreground_image.css("top")))/this.$foreground_image.height()}},end:function(){var c=Math.abs(parseInt(this.$foreground_image.css("left")));var d=Math.abs(parseInt(this.$foreground_image.css("top")));return{x:(c+this.options.width)/this.$foreground_image.width(),y:(d+this.options.height)/this.$foreground_image.height()}}});